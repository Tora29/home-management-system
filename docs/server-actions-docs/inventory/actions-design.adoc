= 在庫管理サーバーアクション 設計書
:toc: left
:toclevels: 3
:sectnums:
:icons: font
:source-highlighter: highlightjs

== 概要

=== ドキュメントの目的
本設計書は、在庫管理システムにおけるサーバーアクション実装の設計と仕様を文書化したものである。
Next.js 15のServer Actions機能を活用した、在庫アイテムの作成・管理機能の実装詳細を提供する。

=== 対象読者
* 開発者
* テストエンジニア
* システムアーキテクト
* プロジェクトマネージャー

=== スコープと範囲
* 在庫アイテムの作成に関するサーバーアクション
* FormDataの処理とバリデーション
* データベース操作（Prisma ORM）
* 履歴記録機能
* エラーハンドリング

== 背景と動機

=== 必要性
在庫管理システムにおいて、アイテムの登録は最も基本的かつ重要な機能の一つである。
この機能は以下の要件を満たす必要がある：

* データの整合性を保証
* 履歴追跡の実現
* ユーザーフレンドリーなエラー処理
* サーバーサイドでのセキュアな処理

=== 解決しようとしている問題
* クライアントサイドでのデータ改竄リスクの排除
* フォームデータの適切なバリデーション
* 在庫履歴の自動記録
* 型安全性の確保

=== ビジネス要件
* 在庫アイテムの正確な登録
* 数量と単位の管理
* 在庫場所の追跡
* カテゴリー分類
* バーコード管理（オプション）

== アーキテクチャ/構造

=== 全体的な構成
[source]
----
├── Server Actions Layer
│   ├── createItemAction (メインエントリーポイント)
│   ├── processFormData (データ処理)
│   ├── validateItemData (バリデーション)
│   ├── saveItem (永続化)
│   └── recordItemHistory (履歴記録)
├── Database Layer (Prisma ORM)
│   ├── Item model
│   └── ItemHistory model
└── Next.js Framework
    ├── revalidatePath (キャッシュ更新)
    └── redirect (ナビゲーション)
----

=== 主要なコンポーネント

==== createItemAction
メインのサーバーアクションである。フォーム送信を受け取り、処理全体を管理する。

==== processFormData
FormDataをJavaScriptオブジェクトに変換する。

==== validateItemData
Zodスキーマによるデータバリデーションを行う。

==== saveItem
検証済みデータのデータベース保存を行う。

==== recordItemHistory
アイテム操作の履歴記録を行う。

=== 依存関係
* `@prisma/client`: データベースORM
* `zod`: スキーマバリデーション
* `next/cache`: キャッシュ管理
* `next/navigation`: ナビゲーション処理

== 詳細設計

=== インターフェース仕様

==== createItemAction
[source,typescript]
----
export async function createItemAction(
  _prevState: {
    success: boolean
    errors?: Record<string, string>
    error?: string
  } | null,
  formData: FormData
): Promise<{
  success: boolean
  errors?: Record<string, string>
  error?: string
} | never>
----

==== processFormData
[source,typescript]
----
export function processFormData(formData: FormData): {
  name: string
  description?: string
  quantity: FormDataEntryValue
  unit: string
  location: string
  barcode?: string
  notes?: string
  categoryId: string
}
----

==== validateItemData
[source,typescript]
----
export function validateItemData(
  data: ReturnType<typeof processFormData>
): CreateItemInput
----

==== saveItem
[source,typescript]
----
export async function saveItem(
  validatedData: ReturnType<typeof validateItemData>
): Promise<Item>
----

==== recordItemHistory
[source,typescript]
----
export async function recordItemHistory(
  item: Awaited<ReturnType<typeof saveItem>>
): Promise<ItemHistory>
----

=== データフロー

[source]
----
1. フォーム送信
   ↓
2. FormData受信 (createItemAction)
   ↓
3. データ処理 (processFormData)
   ↓
4. バリデーション (validateItemData)
   ↓
5. データベース保存 (saveItem)
   ↓
6. 履歴記録 (recordItemHistory)
   ↓
7. キャッシュ更新 (revalidatePath)
   ↓
8. リダイレクト or エラー返却
----

=== 状態管理
* フォーム状態: React Hook Form互換の状態オブジェクト
* エラー状態: フィールド別エラーと全体エラーの管理
* 成功状態: リダイレクトによる暗黙的な成功表現

== 実装ガイドライン

=== ベストプラクティス
* Server Actionsは必ず`'use server'`ディレクティブを先頭に配置
* FormDataの処理は型安全に実行
* バリデーションエラーは構造化された形式で返却
* データベース操作は適切にエラーハンドリング
* リダイレクト処理は特別な例外処理が必要

=== 制約事項と前提条件
* Next.js 15以降のバージョンが必要
* Prismaクライアントの適切な設定が前提
* データベーススキーマとの整合性が必要

=== 注意点とアンチパターン
* リダイレクトエラーをキャッチして握りつぶさない
* FormDataの直接的な型キャストを避ける
* トランザクション処理の考慮（現在は未実装）

== 実装詳細

=== アルゴリズムとロジック

==== FormData処理ロジック
1. FormDataのエントリーをオブジェクトに変換
2. 空文字列の場合はundefinedに変換（オプションフィールド）
3. 必須フィールドは文字列として保持

==== バリデーションロジック
1. Zodスキーマによる型チェック
2. 数値型への自動変換（quantity）
3. 必須フィールドの存在確認
4. 最小値・最大値の検証

=== エラーハンドリング戦略

==== バリデーションエラー
* ZodErrorをキャッチ
* フィールド別にエラーメッセージを構造化
* クライアントに返却して表示

==== データベースエラー
* 一般的なエラーメッセージを返却
* 詳細なエラーログはサーバー側に記録
* ユーザーには安全なメッセージのみ表示

==== リダイレクトエラー
* Next.jsの特殊なエラーとして再スロー
* フレームワークに処理を委譲

=== リトライとフォールバック機構
現在の実装では自動リトライは実装されていない。
将来的な拡張として以下を検討する：
* データベース接続エラー時のリトライ
* 楽観的更新の実装

== 使用例

=== 典型的な使用パターン

==== フォームコンポーネントでの使用
[source,tsx]
----
import { createItemAction } from '@/features/inventory/api/actions'

export function CreateItemForm() {
  return (
    <form action={createItemAction}>
      <input name="name" required />
      <input name="quantity" type="number" required />
      <select name="unit" required>
        <option value="piece">個</option>
        <option value="pack">パック</option>
      </select>
      <button type="submit">登録</button>
    </form>
  )
}
----

==== useActionStateフックとの連携
[source,tsx]
----
'use client'
import { useActionState } from 'react'

export function CreateItemFormWithState() {
  const [state, formAction] = useActionState(createItemAction, null)

  return (
    <form action={formAction}>
      {state?.error && <div>{state.error}</div>}
      {/* フォームフィールド */}
    </form>
  )
}
----

=== ユースケース

==== 新規在庫アイテムの登録
1. ユーザーがフォームに情報を入力
2. 送信ボタンをクリック
3. サーバーアクションが実行
4. 成功時は在庫一覧ページへリダイレクト
5. エラー時はフォームにエラーメッセージを表示

== テスト仕様と検証

=== テストケースから抽出した仕様

==== processFormData関数の仕様
* FormDataをオブジェクトに正確に変換する
* 空文字列の場合、オプションフィールドはundefinedを返す
* 必須フィールドは空文字列でも保持する

==== validateItemData関数の仕様
* 有効なデータは正常に検証を通過する
* 無効なデータはZodErrorをスローする
* 文字列の数量を数値に自動変換する
* 負の数量は検証エラーとなる

==== saveItem関数の仕様
* 有効なデータをPrismaを通じてデータベースに保存する
* データベースエラー時は例外を再スローする
* 保存されたアイテムオブジェクトを返す

==== recordItemHistory関数の仕様
* アイテム作成時に"ADD"アクションとして履歴を記録する
* 初期登録理由は"Initial registration"として記録
* 数量と単位を履歴に保存する

==== createItemAction統合テストの仕様
* バリデーションエラー時はエラーオブジェクトを返す
* データベースエラー時は一般的なエラーメッセージを返す
* 成功時はリダイレクトを実行する

=== テストシナリオ

==== 正常系
* 全必須フィールドが入力された場合の成功
* オプションフィールド省略時の成功

==== 異常系
* 必須フィールド欠損
* 不正な数値（負の数、文字列）
* データベース接続エラー

==== 境界値テスト
* 数量: 0, 1, 最大値
* 文字列長: 空文字、最大長
* カテゴリID: 存在する/しないID

=== カバレッジと品質基準
* ユニットテストカバレッジ: 各関数100%
* 統合テストカバレッジ: 主要なフロー100%
* エッジケース: 重要なケースはカバー

== デプロイメントと運用

=== デプロイ手順
1. 環境変数の設定（DATABASE_URL）
2. Prismaマイグレーションの実行
3. ビルドとデプロイ
4. ヘルスチェックの確認

=== 環境設定の要件
* Node.js 20以上
* PostgreSQLデータベース
* Prisma CLIのインストール

=== モニタリングとログ戦略
* エラーログの記録
* パフォーマンスメトリクスの収集
* 在庫操作の監査ログ

== メンテナンス

=== トラブルシューティングガイド

==== よくある問題
1. **FormDataが空**
   - 原因: フォームのname属性が未設定
   - 解決: 各inputにname属性を追加

2. **リダイレクトが機能しない**
   - 原因: リダイレクトエラーをキャッチしている
   - 解決: isRedirectErrorチェックを追加

3. **バリデーションエラーが表示されない**
   - 原因: エラー状態の処理不足
   - 解決: useActionStateでエラー状態を管理

=== デバッグ手法
* console.logによるFormData内容の確認
* Prismaログの有効化
* Next.jsデバッグモードの活用

== セキュリティ考慮事項

=== 認証・認可の仕組み
現在の実装では認証機能は未実装である。
将来的に以下を実装予定である：
* ユーザー認証の確認
* 操作権限の検証

=== データ保護とプライバシー
* Server Actions によるサーバーサイド処理
* クライアントサイドでの改竄防止
* SQLインジェクション対策（Prisma ORM）

=== 潜在的な脆弱性と対策
* CSRF攻撃: Next.jsの組み込み対策を利用
* XSS攻撃: 適切なエスケープ処理
* マスアサインメント: 明示的なフィールド指定

== パフォーマンス考慮事項

=== パフォーマンス要件
* フォーム送信から応答まで: 2秒以内
* データベース操作: 500ms以内
* バリデーション処理: 100ms以内

=== 最適化ポイント
* revalidatePathによる選択的キャッシュ更新
* データベースインデックスの活用
* 不要なフィールドの除外

=== スケーラビリティ設計
* データベース接続プールの管理
* 非同期処理による並行性の確保
* 将来的なキューシステムの導入検討

== 参考資料

=== 関連ドキュメント
* Feature-Sliced Design アーキテクチャルール
* Prisma スキーマ定義
* Next.js Server Actions ドキュメント

=== 外部リソース
* link:https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations[Next.js Server Actions公式ドキュメント]
* link:https://www.prisma.io/docs[Prisma公式ドキュメント]
* link:https://zod.dev[Zod公式ドキュメント]

== 改訂履歴

[cols="1,2,3,4", options="header"]
|===
|バージョン |日付 |作成者 |変更内容
|1.0.0 |2025-09-17 |Claude Code |初版作成
|===