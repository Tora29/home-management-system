= 在庫管理クエリ関数 設計書
:toc: left
:toclevels: 3
:sectnums:
:icons: font
:source-highlighter: highlightjs

== 概要

=== ドキュメントの目的
本設計書は、在庫管理システムにおけるFeatures層のクエリ関数（`getMasterData`）の設計と仕様を文書化したものである。
複数のエンティティにまたがるマスターデータの一括取得を担当する重要な関数の実装詳細を提供する。

=== 対象読者
* 開発者
* テストエンジニア
* システムアーキテクト
* プロジェクトマネージャー

=== スコープと範囲
* マスターデータ（カテゴリ、単位、保管場所）の一括取得
* 並列クエリ処理によるパフォーマンス最適化
* アクティブなデータのみのフィルタリング
* ソート順に基づく並び替え

== 背景と動機

=== 必要性
在庫管理システムにおいて、フォームの選択肢やマスターデータは頻繁に参照される重要な情報である。
これらのデータを効率的に取得することで、以下を実現する：

* UIの高速なレンダリング
* 複数APIコールの削減
* 一貫性のあるデータ提供
* サーバーラウンドトリップの最小化

=== 解決しようとしている問題
* 複数のマスターテーブルへの個別アクセスによるパフォーマンス低下
* N+1クエリ問題の回避
* データ取得の一元化による保守性向上
* 非アクティブなデータの除外

=== ビジネス要件
* カテゴリ、単位、保管場所の最新情報を提供
* アクティブなデータのみを表示
* ユーザー定義の並び順に従った表示
* 高速なレスポンスタイムの実現

== アーキテクチャ/構造

=== 全体的な構成
[source]
----
Features層 (queries.ts)
    │
    ├── getMasterData関数
    │   ├── Promise.allによる並列処理
    │   ├── カテゴリ取得
    │   ├── 単位取得
    │   └── 保管場所取得
    │
    └── Prisma ORM層
        ├── categoryモデル
        ├── unitモデル
        └── locationモデル
----

=== 主要なコンポーネント

==== getMasterData関数
複数のマスターデータを並列で取得し、単一のオブジェクトとして返却する関数である。

==== Promise.all並列処理
3つのデータベースクエリを同時実行し、全ての完了を待機する。

==== フィルタリング条件
`isActive: true` によるアクティブデータのフィルタリングを行う。

==== ソート処理
`sortOrder: 'asc'` による昇順ソートを行う。

=== 依存関係
* `@/shared/lib/prisma`: Prismaクライアントインスタンス
* `@/entities/inventory/model`: 型定義（Category, Unit, Location）
* `@prisma/client`: Prisma ORMライブラリ

== 詳細設計

=== インターフェース仕様

==== getMasterData関数
[source,typescript]
----
export async function getMasterData(): Promise<{
  categories: Category[]
  units: Unit[]
  locations: Location[]
}>
----

===== パラメータ
なし

===== 戻り値
[cols="2,3,5", options="header"]
|===
|プロパティ |型 |説明
|categories |Category[] |アクティブなカテゴリのリスト（ソート済み）
|units |Unit[] |アクティブな単位のリスト（ソート済み）
|locations |Location[] |アクティブな保管場所のリスト（ソート済み）
|===

=== データフロー

[source]
----
1. getMasterData関数の呼び出し
   ↓
2. Promise.allによる並列クエリ開始
   ├── カテゴリクエリ
   ├── 単位クエリ
   └── 保管場所クエリ
   ↓
3. 各クエリの実行
   ├── isActive: trueでフィルタ
   └── sortOrder: ascでソート
   ↓
4. 全クエリの完了待機
   ↓
5. 結果をオブジェクトに統合
   ↓
6. 呼び出し元に返却
----

=== 状態管理
* ステートレス関数として実装
* データベースの現在の状態を反映
* キャッシュは呼び出し元の責任で管理

== 実装ガイドライン

=== ベストプラクティス
* Promise.allを使用した並列処理の実装
* アクティブフラグによる論理削除データの除外
* 一貫性のあるソート順の適用
* 型安全性の確保（TypeScript）

=== 制約事項と前提条件
* Prismaクライアントの正常な接続が前提
* データベーススキーマにisActiveとsortOrderフィールドが必須
* 各テーブルが同一のフィルタリング・ソート要件を持つこと

=== 注意点とアンチパターン
* 順次クエリ実行を避ける（パフォーマンス低下）
* 個別のエラーハンドリングを行わない（全体失敗の原則）
* クライアント側でのフィルタリングを避ける

== 実装詳細

=== アルゴリズムとロジック

==== 並列クエリ処理
1. 3つのfindManyクエリを配列として定義
2. Promise.allで同時実行
3. 全ての結果を待機
4. 配列の分割代入で各結果を取得

==== フィルタリングロジック
* `where: { isActive: true }`: アクティブレコードのみ取得
* 物理削除ではなく論理削除をサポート

==== ソートロジック
* `orderBy: { sortOrder: 'asc' }`: 管理者定義の順序で表示
* ユーザーエクスペリエンスの一貫性を保証

=== エラーハンドリング戦略

==== Promise.allのエラー処理
* いずれかのクエリが失敗した場合、全体が失敗
* 最初に発生したエラーが伝播される
* 部分的成功は許可されない（トランザクション的動作）

==== データベースエラー
* Prismaのエラーをそのまま上位に伝播
* 呼び出し元でエラーハンドリングを実装

=== リトライとフォールバック機構
現在の実装では自動リトライは実装されていない。
将来的な拡張として以下を検討する：
* データベース接続エラー時のリトライ
* キャッシュレイヤーの追加
* フォールバックデータの提供

== 使用例

=== 典型的な使用パターン

==== RSC（React Server Component）での使用
[source,tsx]
----
// app/(routes)/inventory/new/page.tsx
import { getMasterData } from '@/features/inventory/api/queries'

export default async function NewInventoryPage() {
  const { categories, units, locations } = await getMasterData()

  return (
    <InventoryForm
      categories={categories}
      units={units}
      locations={locations}
    />
  )
}
----

==== API Route Handlerでの使用
[source,typescript]
----
// app/api/master-data/route.ts
import { getMasterData } from '@/features/inventory/api/queries'
import { NextResponse } from 'next/server'

export async function GET() {
  try {
    const data = await getMasterData()
    return NextResponse.json(data)
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to fetch master data' },
      { status: 500 }
    )
  }
}
----

=== ユースケース

==== 在庫登録フォームの初期化
1. ページコンポーネントでgetMasterDataを呼び出し
2. カテゴリ、単位、保管場所のデータを取得
3. フォームコンポーネントに渡してセレクトボックスを構築

==== マスターデータの事前取得
1. レイアウトコンポーネントでデータを取得
2. 子コンポーネントにpropsとして伝播
3. 複数ページで再利用

== テスト仕様と検証

=== テストケースから抽出した仕様

==== 正常系の仕様
* 全てのマスターデータを正常に取得できる
* 空の結果でも正常に動作する（空配列を返す）
* 並列処理で全てのクエリが同時実行される
* isActive: trueのフィルタが適用される
* sortOrder: ascのソートが適用される

==== 異常系の仕様
* カテゴリ取得エラー時は全体がエラーとなる
* 単位取得エラー時は全体がエラーとなる
* 場所取得エラー時は全体がエラーとなる
* 複数のエラーが発生した場合、最初のエラーが伝播される

==== パフォーマンスの仕様
* クエリが順次実行ではなく並列実行される
* 最も遅いクエリの完了時間で全体が完了する
* 個別のクエリ時間の合計より高速に完了する

=== テストシナリオ

==== 正常系
* データが存在する場合の取得成功
* データが空の場合の取得成功
* 大量データでのパフォーマンス確認

==== 異常系
* データベース接続エラー
* タイムアウトエラー
* 権限エラー

==== 境界値テスト
* 0件のデータ
* 1件のデータ
* 大量データ（1000件以上）

=== カバレッジと品質基準
* ユニットテストカバレッジ: 100%達成
* 並列処理のテスト: 実装済み
* エラーハンドリング: 全パターンカバー
* パフォーマンステスト: 並列実行の検証済み

== デプロイメントと運用

=== デプロイ手順
1. 環境変数DATABASE_URLの設定
2. Prismaマイグレーションの実行
3. マスターデータの初期投入
4. アプリケーションのビルドとデプロイ

=== 環境設定の要件
* Node.js 20以上
* PostgreSQLデータベース
* Prisma CLI
* 適切なデータベース権限（SELECT権限必須）

=== モニタリングとログ戦略
* クエリ実行時間の計測
* エラー発生率の監視
* データベース接続プールの状態確認
* スロークエリの検出とアラート

== メンテナンス

=== トラブルシューティングガイド

==== よくある問題

1. **マスターデータが取得できない**
   - 原因: データベース接続エラー
   - 解決: DATABASE_URL環境変数を確認

2. **特定のデータが表示されない**
   - 原因: isActiveがfalseに設定されている
   - 解決: データベースでisActiveフラグを確認

3. **データの順序がおかしい**
   - 原因: sortOrderが正しく設定されていない
   - 解決: 各レコードのsortOrder値を確認・修正

4. **パフォーマンスが遅い**
   - 原因: インデックスが不足している
   - 解決: isActiveとsortOrderに複合インデックスを作成

=== デバッグ手法
* Prismaのログレベルを上げてSQL確認
* console.timeでクエリ実行時間を計測
* Chrome DevToolsのNetworkタブで応答時間確認

== セキュリティ考慮事項

=== 認証・認可の仕組み
現在の実装では認証機能は未実装である。
将来的に以下を実装予定である：
* ユーザー認証の確認
* ロールベースアクセス制御
* テナント分離

=== データ保護とプライバシー
* サーバーサイドでのみデータベースアクセス
* 環境変数によるデータベース資格情報の保護
* SQLインジェクション対策（Prisma ORM使用）

=== 潜在的な脆弱性と対策
* 大量データによるメモリ枯渇: ページネーション実装を検討
* DoS攻撃: レート制限の実装を検討
* データ漏洩: 適切な権限管理とログ監査

== パフォーマンス考慮事項

=== パフォーマンス要件
* API応答時間: 200ms以内
* 並列クエリによる高速化: 3倍以上の改善
* 同時接続数: 100ユーザー対応

=== 最適化ポイント
* Promise.allによる並列処理（実装済み）
* データベースインデックスの活用
* 結果のキャッシング（Next.jsのキャッシュ層）
* 不要なフィールドの除外（Prisma select）

=== スケーラビリティ設計
* 読み取り専用レプリカの活用
* Redis等のキャッシュレイヤー追加
* CDNによる静的データ配信
* GraphQLによる柔軟なデータ取得

== 参考資料

=== 関連ドキュメント
* Feature-Sliced Design アーキテクチャルール
* Prismaスキーマ定義（schema.prisma）
* 在庫管理システム全体設計書

=== 外部リソース
* link:https://www.prisma.io/docs/orm/prisma-client/queries/select-fields[Prisma Client - Select fields]
* link:https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all[MDN - Promise.all()]
* link:https://nextjs.org/docs/app/building-your-application/data-fetching[Next.js - Data Fetching]

== 改訂履歴

[cols="1,2,3,4", options="header"]
|===
|バージョン |日付 |作成者 |変更内容
|1.0.0 |2025-09-19 |Claude Code |初版作成 - getMasterData関数の設計書を作成
|===